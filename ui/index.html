<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <canvas id="canvas"></canvas>
    <canvas id="canvas1" width="64", height="64"></canvas>
    <script type='module' src='./dist/game.js'></script>
    <script type="module">
        import DodgeGameEnv from './dist/game.js';
        try {
            const myOnnxSession = new onnx.InferenceSession();
            const game = new DodgeGameEnv()
            let observation = game.getObservation()
            //console.log(observation)
            // load the ONNX model file
            await myOnnxSession.loadModel("./my_ppo_model.onnx");

            const loop = async () => {
                //console.log(observation)
                const rgbData = [];
                for(let i = 0; i < observation.length; i += 4) {
                    rgbData.push(observation[i], observation[i+1], observation[i+2]);
                }

                const input = [
                    new Tensor(new Float32Array(rgbData), "float32", [1, 3, 64, 64]),
                ];
                //console.log(input)
                //console.log(myOnnxSession)
                const outputMap = await myOnnxSession.run(input);
                const outputTensor = outputMap.values().next().value;
                //console.log(outputTensor.data, typeof outputTensor, typeof outputTensor.data, outputTensor.data.keys(), Array.from(outputTensor.data))

                //const action = outputTensor.data.indexOf(Math.max(...outputTensor.data))
                const action = (await tf.multinomial(outputTensor.data, 1).data())[0]
                //console.log(action, outputTensor.data.indexOf(Math.max(...outputTensor.data)))
                const [_obs, _reward, done, _info] = game.step(action)
                observation = _obs
                game.render()
                if (done) game.reset()

                // Put the modified pixel data back on the canvas
                const canvas1 = document.getElementById('canvas1')
                const ctx = canvas1.getContext("2d");
                //imageData.data.set(new Uint8ClampedArray(observation));
                const imageData = new ImageData(64, 64, new Uint8ClampedArray(observation))
                //console.log(observation.filter(e => e != 0))
                //console.log(observation)
                //console.log(imageData)
                //ctx.putImageData(imageData, 0, 0);

                window.requestAnimationFrame(loop);
                // console.log(this.game_over, this.hp)
            };
            window.requestAnimationFrame(loop);
           
            /*// Load the ONNX model
            const model = await myOnnxSession.load('./my_ppo_model.onnx');
            console.log(model)

            // Create a session and input tensor
            const session = new onnx.InferenceSession({ model });
            const input = new onnx.Tensor(new Float32Array([1, 2, 3, 4]), "float32", [1, 2, 2]);

            // Run inference on the model
            const outputMap = await session.run([input]);

            // Extract the output tensor
            const output = outputMap.values().next().value.data;

            console.log(output);*/
        } catch (e) {
            console.log(e)
            document.write(`failed to inference ONNX model: ${e}.`);
        }
    </script>
</body>
</html>